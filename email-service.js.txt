// Email service for approval system

class EmailService {
    constructor() {
        this.settings = {};
        this.init();
    }

    async init() {
        this.settings = await getSettings();
    }

    async sendApprovalEmail(document) {
        try {
            const subject = `Approval Required: ${document.docType.toUpperCase()} - ${document.docRef}`;
            const body = this.createEmailBody(document);
            
            const emailData = {
                to: this.settings.approvalEmail,
                cc: this.settings.ccEmails,
                subject: subject,
                body: body
            };
            
            // Using puter.js email functionality if available
            if (typeof puter !== 'undefined' && puter.sendEmail) {
                await puter.sendEmail(emailData);
                return { success: true, message: 'Email sent successfully' };
            } else {
                // Fallback to mailto link
                this.sendMailToLink(emailData);
                return { success: true, message: 'Email client opened' };
            }
        } catch (error) {
            console.error('Error sending email:', error);
            return { success: false, message: error.message };
        }
    }

    createEmailBody(document) {
        const docType = document.docType.toUpperCase();
        const date = new Date(document.date).toLocaleDateString();
        const dueDate = document.dueDate ? new Date(document.dueDate).toLocaleDateString() : 'N/A';
        
        return `
SAMANI CREATIONS LTD - DOCUMENT APPROVAL REQUEST

Document Type: ${docType}
Reference: ${document.docRef}
Date: ${date}
Due Date: ${dueDate}

CLIENT INFORMATION
------------------
Client: ${document.clientName}
Project: ${document.projectName}
Email: ${document.clientEmail || 'N/A'}
Phone: ${document.clientPhone}
Site: ${document.clientSite || 'N/A'}

FINANCIAL SUMMARY
-----------------
Subtotal: UGX ${document.subtotal?.toLocaleString() || '0'}
Tax (18%): UGX ${document.taxAmount?.toLocaleString() || '0'}
GRAND TOTAL: UGX ${document.grandTotal?.toLocaleString() || '0'}

Payment Terms: ${document.paymentTerms}

ITEMS & SERVICES
----------------
${document.items?.map(item => 
    `• ${item.name}: ${item.quantity} x UGX ${item.rate?.toLocaleString()} = UGX ${item.total?.toLocaleString()}`
).join('\n') || 'No items'}

NOTES
-----
${document.notes || 'No additional notes'}

APPROVAL ACTION REQUIRED
------------------------
Please review this document and reply to this email with:
- "APPROVED" to approve the document
- "REJECTED" to reject the document
- Any comments or modifications needed

The document will remain pending until approved.

This email was automatically generated by SAMANI CREATIONS Professional Invoicing System.
        `.trim();
    }

    sendMailToLink(emailData) {
        const cc = emailData.cc.split(',').map(email => email.trim()).join(',');
        const mailtoLink = `mailto:${emailData.to}?cc=${cc}&subject=${encodeURIComponent(emailData.subject)}&body=${encodeURIComponent(emailData.body)}`;
        window.open(mailtoLink, '_blank');
    }

    async sendDailyReport(reportData) {
        try {
            const subject = `SAMANI CREATIONS Daily Report - ${new Date().toLocaleDateString()}`;
            const body = this.createDailyReportBody(reportData);
            
            const emailData = {
                to: this.settings.approvalEmail,
                cc: this.settings.ccEmails,
                subject: subject,
                body: body
            };
            
            if (typeof puter !== 'undefined' && puter.sendEmail) {
                await puter.sendEmail(emailData);
                return { success: true };
            } else {
                this.sendMailToLink(emailData);
                return { success: true };
            }
        } catch (error) {
            console.error('Error sending daily report:', error);
            return { success: false };
        }
    }

    createDailyReportBody(reportData) {
        return `
SAMANI CREATIONS LTD - DAILY BUSINESS REPORT
Date: ${new Date().toLocaleDateString()}

SUMMARY
-------
Total Documents Today: ${reportData.totalDocuments}
Quotations Created: ${reportData.quotes}
Invoices Created: ${reportData.invoices}
Receipts Issued: ${reportData.receipts}
Total Revenue: UGX ${reportData.totalRevenue?.toLocaleString() || '0'}

PENDING ACTIONS
---------------
Documents Pending Approval: ${reportData.pendingApprovals}
Overdue Invoices: ${reportData.overdueInvoices}

RECENT ACTIVITY
---------------
${reportData.recentActivity?.map(activity => 
    `• ${activity.time}: ${activity.type} ${activity.ref} - ${activity.client} (UGX ${activity.amount?.toLocaleString()})`
).join('\n') || 'No activity today'}

CLIENT ACTIVITY
---------------
${reportData.topClients?.map(client => 
    `• ${client.name}: ${client.documents} documents, UGX ${client.total?.toLocaleString()}`
).join('\n') || 'No client activity'}

This report was automatically generated by SAMANI CREATIONS Professional Invoicing System.
        `.trim();
    }
}

const emailService = new EmailService();

// Export functions
async function sendApprovalEmail(document) {
    return emailService.sendApprovalEmail(document);
}

async function sendDailyReport(reportData) {
    if (emailService.settings.autoReports) {
        return emailService.sendDailyReport(reportData);
    }
    return { success: false, message: 'Auto reports disabled' };
}

// Auto-send daily report at end of day
function scheduleDailyReport() {
    const now = new Date();
    const endOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
    const timeUntilEndOfDay = endOfDay.getTime() - now.getTime();
    
    setTimeout(async () => {
        const reportData = await generateDailyReportData();
        await sendDailyReport(reportData);
        
        // Schedule for next day
        scheduleDailyReport();
    }, timeUntilEndOfDay);
}

// Start scheduler
setTimeout(scheduleDailyReport, 1000);

// Make functions available globally
window.sendApprovalEmail = sendApprovalEmail;
window.sendDailyReport = sendDailyReport;